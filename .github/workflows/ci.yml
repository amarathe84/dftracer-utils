name: CI

on:
  push:
    branches: [ main, develop, initialize, call-stack-multiproc ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    env:
      CMAKE_POLICY_VERSION_MINIMUM: 3.5

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, ubuntu-latest, macos-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake lcov zlib1g-dev libsqlite3-dev pkg-config
    
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update
        for f in cmake lcov zlib sqlite pkg-config; do
          if brew list --versions "$f" >/dev/null; then
            echo "$f already installed"
          else
            brew install "$f"
          fi
        done

    - name: Run coverage
      if: matrix.os == 'ubuntu-22.04'
      run: |
        make coverage

    - name: Run test (Unix)
      if: matrix.os != 'ubuntu-22.04'
      run: |
        make test
    
    - name: Run Python tests (with venv)
      run: |
        make test-py
    
    - name: Run Python tests (without venv)
      run: |
        pip install --upgrade pip setuptools wheel
        pip install -e ".[dev]"
        pytest tests/python -v
    
    - name: Upload coverage reports to Codecov (Unix)
      if: matrix.os == 'ubuntu-22.04'
      uses: codecov/codecov-action@v4
      with:
        file: build-coverage/coverage/coverage_filtered.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        verbose: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-mpi:
    name: MPI Multi-Process Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        mpi: [openmpi, mpich]
        num-procs: [2, 4, 8]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install MPI (Ubuntu - OpenMPI)
      if: runner.os == 'Linux' && matrix.mpi == 'openmpi'
      run: |
        sudo apt-get update
        sudo apt-get install -y openmpi-bin libopenmpi-dev
        mpirun --version
    
    - name: Install MPI (Ubuntu - MPICH)
      if: runner.os == 'Linux' && matrix.mpi == 'mpich'
      run: |
        sudo apt-get update
        sudo apt-get install -y mpich libmpich-dev
        mpirun --version
    
    - name: Install build dependencies
      run: |
        sudo apt-get install -y build-essential cmake zlib1g-dev libsqlite3-dev pkg-config
    
    - name: Build with MPI support
      run: |
        mkdir -p build_mpi
        cd build_mpi
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DDFTRACER_UTILS_ENABLE_MPI=ON \
              -DDFTRACER_UTILS_TESTS=ON \
              -DCMAKE_INSTALL_PREFIX=$(pwd)/install \
              ..
        make -j$(nproc)
        make install
    
    - name: Verify MPI binary exists
      run: |
        ls -la build_mpi/bin/dftracer_call_graph_mpi
        ldd build_mpi/bin/dftracer_call_graph_mpi || true
    
    - name: Test MPI call graph with ${{ matrix.num-procs }} processes
      run: |
        # Use short traces for CI testing
        if [ -d "trace_short" ]; then
          TRACE_FILE="trace_short/bert_v100-1.pfw"
        else
          TRACE_FILE="trace/bert_v100-1.pfw"
        fi
        
        echo "Testing with ${{ matrix.num-procs }} MPI processes on trace: $TRACE_FILE"
        mpirun -np ${{ matrix.num-procs }} \
               --oversubscribe \
               build_mpi/bin/dftracer_call_graph_mpi \
               $TRACE_FILE \
               --output-dir build_mpi/test_output_np${{ matrix.num-procs }}
    
    - name: Validate MPI output
      run: |
        OUTPUT_DIR="build_mpi/test_output_np${{ matrix.num-procs }}"
        
        # Check that output was generated
        if [ ! -d "$OUTPUT_DIR" ]; then
          echo "Error: Output directory not created"
          exit 1
        fi
        
        # List generated files
        echo "Generated files:"
        find "$OUTPUT_DIR" -type f
        
        # Verify call graph files were created
        GRAPH_FILES=$(find "$OUTPUT_DIR" -name "*.json" -o -name "*.dot" -o -name "*.txt" | wc -l)
        echo "Found $GRAPH_FILES graph files"
        
        if [ "$GRAPH_FILES" -eq 0 ]; then
          echo "Warning: No graph files generated"
        fi
    
    - name: Test MPI correctness (compare with serial)
      if: matrix.num-procs == 4
      run: |
        # Build and run serial version for comparison
        if [ -d "trace_short" ]; then
          TRACE_FILE="trace_short/bert_v100-1.pfw"
        else
          TRACE_FILE="trace/bert_v100-1.pfw"
        fi
        
        # Run serial version
        build_mpi/bin/dftracer_call_graph \
          $TRACE_FILE \
          --output-dir build_mpi/test_output_serial
        
        echo "Serial output:"
        find build_mpi/test_output_serial -type f
        
        echo "MPI output:"
        find build_mpi/test_output_np${{ matrix.num-procs }} -type f
    
    - name: Upload MPI test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mpi-test-output-${{ matrix.os }}-${{ matrix.mpi }}-np${{ matrix.num-procs }}
        path: |
          build_mpi/test_output_*
          build_mpi/bin/dftracer_call_graph_mpi
        retention-days: 7

  test-multiprocess-stress:
    name: Multi-Process Stress Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y openmpi-bin libopenmpi-dev build-essential cmake zlib1g-dev libsqlite3-dev pkg-config
    
    - name: Build with MPI and debug support
      run: |
        mkdir -p build_stress
        cd build_stress
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DDFTRACER_UTILS_ENABLE_MPI=ON \
              -DDFTRACER_UTILS_DEBUG=ON \
              -DDFTRACER_UTILS_TESTS=ON \
              ..
        make -j$(nproc)
    
    - name: Create test traces
      run: |
        # Use short traces if available, otherwise create minimal test trace
        if [ ! -d "trace_short" ] && [ ! -f "trace/bert_v100-1.pfw" ]; then
          mkdir -p trace_test
          echo '[' > trace_test/test.pfw
          echo '{"id":1,"name":"HH","cat":"dftracer","pid":1000,"tid":1000,"ph":"M","args":{"hhash":"test","name":"host","value":"test"}}' >> trace_test/test.pfw
          echo ']' >> trace_test/test.pfw
        fi
    
    - name: Run stress tests with varying process counts
      run: |
        for np in 1 2 4 6 8; do
          echo "=== Testing with $np processes ==="
          
          if [ -d "trace_short" ]; then
            TRACE_FILE="trace_short/bert_v100-1.pfw"
          elif [ -f "trace/bert_v100-1.pfw" ]; then
            TRACE_FILE="trace/bert_v100-1.pfw"
          else
            TRACE_FILE="trace_test/test.pfw"
          fi
          
          mpirun -np $np --oversubscribe \
                 build_stress/bin/dftracer_call_graph_mpi \
                 $TRACE_FILE \
                 --output-dir build_stress/stress_test_np${np} || echo "Warning: Test with $np processes failed"
        done
    
    - name: Verify stress test outputs
      run: |
        echo "Stress test results:"
        for dir in build_stress/stress_test_np*; do
          if [ -d "$dir" ]; then
            echo "=== $dir ==="
            find "$dir" -type f | head -10
          fi
        done
